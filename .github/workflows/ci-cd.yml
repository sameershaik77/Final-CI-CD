name: CI/CD Pipeline

on:
  push:
    branches: ["main"]

env:
  IMAGE_NAME: sameershaik77/final-ci-cd
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 2: Setup Docker
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Step 3: Login to DockerHub
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Step 4: Build and push Docker image
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/final-ci-cd:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/final-ci-cd:${{ github.sha }}

    # Step 5: Prepare deployment files
    - name: Prepare deployment files
      run: |
        # Create deploy directory
        mkdir -p deploy
        
        # Copy docker-compose
        cp docker-compose.yml deploy/
        
        # Create .env file
        cat > deploy/.env << EOF
        IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/final-ci-cd:latest
        PORT=8080
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        DB_USER=postgres
        DB_PASSWORD=postgres
        DB_NAME=appdb
        EOF
        
        # Create deploy.sh script
        cat > deploy/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "=== Starting deployment ==="
        
        # Load environment
        export $(cat .env | xargs)
        
        echo "Pulling Docker image: $IMAGE"
        docker pull $IMAGE || true
        
        echo "Stopping old containers..."
        docker compose down || true
        
        echo "Starting new containers..."
        docker compose up -d --remove-orphans
        
        echo "Cleaning up..."
        docker system prune -f
        
        echo "=== Deployment complete ==="
        echo "Application running on: http://$(curl -s ifconfig.me):8080"
        EOF
        
        # Make script executable
        chmod +x deploy/deploy.sh
        
        # List files to verify
        echo "Deploy files created:"
        ls -la deploy/

    # Step 6: Setup SSH
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Add EC2 to known hosts
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        # Test SSH connection
        echo "Testing SSH connection..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful'"

    # Step 7: Copy files to server
    - name: Copy files to server
      run: |
        echo "Copying files to EC2..."
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r deploy/* ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/home/${{ secrets.SSH_USER }}/deploy/

    # Step 8: Deploy on server
    - name: Deploy on server
      run: |
        echo "Deploying application on EC2..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /home/${{ secrets.SSH_USER }}/deploy
          ls -la
          chmod +x deploy.sh
          ./deploy.sh
        EOF

    # Step 9: Verify deployment
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "Checking Docker containers:"
          docker ps
          echo ""
          echo "Checking application health:"
          curl -s http://localhost:8080/health || echo "Health check failed"
        EOF